<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    </head>
    <body>
        <script src = "trystero_bundled.js"></script>
        <script type="module">
            const selfId = trystero.selfId;
            const joinRoom = trystero.joinRoom;

            const room_name = "main";

            const key_generation_config = {
                name: "ECDSA",
                namedCurve: "P-384"
            };

            const key_import_config = {
                name: 'ECDSA',
                hash: {name: "SHA-384"},
            };

            let key_pair;

            const existing_key_pair = JSON.parse(localStorage.getItem("key_pair"));

            if (existing_key_pair == null) {
                key_pair = await crypto.subtle.generateKey(
                    key_generation_config,
                    true,
                    ["sign", "verify"]
                );

                console.log("Generated new keypair");

                localStorage.setItem("key_pair", JSON.stringify({
                    publicKey: await crypto.subtle.exportKey("jwk", key_pair.publicKey),
                    privateKey: await crypto.subtle.exportKey("jwk", key_pair.privateKey),
                }));
            } else {
                key_pair = {
                    publicKey: await crypto.subtle.importKey("jwk", existing_key_pair.publicKey, key_import_config, true, ['verify']),
                    privateKey: await crypto.subtle.importKey("jwk", existing_key_pair.privateKey, key_import_config, true, ['sign']),
                };

                console.log("Loaded existing keypair");
            }

            const contacts = JSON.parse(localStorage.getItem("contacts")) || {};

            const room = joinRoom({ appId: "webxr_pbr_wasm", signing_key: key_pair }, room_name);

            const self_key_id = await make_key_id(key_pair.publicKey);
            console.log(`My key id: '${self_key_id}'`);

            let exported = await crypto.subtle.exportKey("jwk", key_pair.publicKey);

            const peers = {};

            function contact_name(peer_id) {
                const key_id = peers[peer_id].key_id;

                return `'${key_id}'/'${key_id in contacts ? contacts[key_id] : 'unknown'}'`;
            }

            async function make_key_id(key) {
                const exported_key = await crypto.subtle.exportKey('raw', key);
                const key_digest = await crypto.subtle.digest('SHA-256', exported_key);

                const pack = buff => {
                    return btoa(String.fromCharCode.apply(null, new Uint8Array(buff)))
                };

                return pack(key_digest).slice(0, 10);
            }

            room.onPeerJoin(async (peer, peer_id) => {
                peers[peer_id] = {
                    peer: peer,
                    key_id: await make_key_id(peer.key)
                };

                console.log(`${contact_name(peer_id)} joined`);
            });

            const [send_chat_msg, get_chat_msg] = room.makeAction('chat');

            get_chat_msg((msg, peer_id) => {
                const key_id = peers[peer_id].key_id;

                console.log(`${contact_name(peer_id)}: ${msg}`);
            });

            window.send_chat_msg = send_chat_msg;

            window.add_contact = (key_id, name) => {
                contacts[key_id] = name;
                console.log(contacts);
                localStorage.setItem("contacts", JSON.stringify(contacts));
            };
        </script>
    </body>
</html>
